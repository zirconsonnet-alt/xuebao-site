# 音乐理论逻辑定义 (Based on enum.py)

本文档描述系统内部使用的音乐理论基础概念、和声语汇及声部法则。本模块属于**领域内核（Domain Core）**：仅提供纯数据结构与纯运算，不引入任何运行时状态、IO、副作用或上层策略。

---

## 1. 基础构成 (Foundations)

### Degrees (音级)
- **理论含义**：旋律与和声的骨架，描述调性内的相对位置（罗马数字 I - VII）。
- **应用场景**：无论是在 C 大调还是 F# 大调，`I` 级永远代表主音，`V` 级永远代表属音。
- **运算逻辑**：
  - 支持 **加法 / 减法**，且均为 `1~7` 的循环运算。
  - **减法语义**：`A - B` 表示「`A` 在以 `B` 为主音（I级）的调内是几级音」。
    - 例：`I - VII = II`（以 VII 为 I 时，原 I 变为 II）
  - **加法语义**：`A + B` 表示「从 `A` 向上推进 `B` 级后的音级」。
    - 例：`VI + III = I`（循环）

---

### NoteNames (自然音名)
- **理论含义**：基音的名称属性（C, D, E, F, G, A, B），并提供与半音数（Pitch Class）的基础映射。
- **应用场景**：
  - 通过与 `Degrees` 结合确定另一个自然音名，例如「以 `C` 为主音的调中 `II` 级音的音名是 `D`」。
- **运算逻辑**：
  - 支持与 `Degrees` 的加减运算：
    - `NoteNames(X) + Degree(n)`：以 `X` 为主音，向上数 `n` 级得到的音名。
    - `NoteNames(X) - Degree(n)`：以 `X` 为主音，向下数 `n` 级得到的音名。
  - 支持音名之间的“级差”运算：
    - `NoteNames(A) | NoteNames(B)`：返回 `A` 相对 `B` 的音级差（`Degrees`）。
- **对应乐理约束**：在一个 7 声音阶中，7 个自然音名各自只出现一次（本层不处理升降号拼写的等音异名问题）。

---

### Intervals (音程)
描述两个基音之间的“音级差 + 半音偏移”的二元结构。
- **理论含义**：对应「大二度」「增一度」「纯五度」等概念，一般形式为（大/小/增/减）n度。
- **应用场景**：
  - 用于基音的加减法（推导目标基音）。
  - 用于基音之间的音程计算（推导两基音的 Interval 枚举）。
- **运算逻辑**：
  - 每个 `Intervals` 具有形如 `(Degrees, semitone)` 的值：
    - `Degrees`：音名跨度（几度）
    - `semitone`：半音跨度（0~11）
  - 具体用法见「基音（BaseNote）」章节。

---

### BaseNote (基音 / 记谱基音 / 音名)
`BaseNote` 是系统的“可计算基音实体”，用于表达 **音名 + 升降号拼写**，并携带其对应的 **12 平均律音高类（Pitch Class）**。

#### 1) 数据结构
- **构成**：`BaseNote(note_name: NoteNames, shifts: int)`
  - `note_name`：自然音名（C~B）
  - `shifts`：升降号数量
    - `+1` 表示 `#`，`+2` 表示 `##`
    - `-1` 表示 `b`，`-2` 表示 `bb`
  - `offset`：音高类（Pitch Class），定义为  
    `offset = (note_name.value + shifts) % 12`
- **约束**：
  - `|shifts| <= MAX_SHIFTS`（默认 `MAX_SHIFTS = 2`）
  - 本对象表达的是**拼写（Spelling）**，而不是“等音同一”（例如 `C#` 与 `Db` 在此层不视为相等）。

#### 2) 显示与相等性
- **字符串表示**：
  - `C` → `"C"`
  - `F#` → `"F#"`
  - `Ebb` → `"Ebb"`
- **相等性**：
  - `BaseNote` 的相等以拼写为准：`note_name` 与 `shifts` 均相同才相等。
  - 因此 `C# != Db`（尽管二者 `offset` 可能相同）。

#### 3) 基音与音程运算
- **加法**：`BaseNote + Intervals -> BaseNote`
  - 音名按度数推进：`note_name' = note_name + interval.degree`
  - 音高按半音推进：`offset' = (offset + interval.semitone) % 12`
  - 由 `(note_name', offset')` 反求 `shifts'` 得到目标基音。
- **减法**：`BaseNote - Intervals -> BaseNote`
  - 与加法对称，方向相反。
- **音程差**：`BaseNote | BaseNote -> Intervals`
  - 返回从当前基音到目标基音的音程：
    - 级差 = 两音名之间的 `Degrees` 差
    - 半音差 = 两 `offset` 的差（mod 12）
  - 再由 `(Degrees, semitone)` 映射回 `Intervals` 枚举项。

#### 4) 反求拼写（from_name_and_offset）
给定目标自然音名 `note_name` 与目标音高类 `offset`，求一组 `shifts` 使其满足：
`(note_name.value + shifts) % 12 == offset`

- 本实现采用“**最接近 0 的 shifts**”策略在等价拼写中取一个代表。
- 若所需 `shifts` 超过 `MAX_SHIFTS`，将直接报错，以保证拼写约束不会被悄然突破。

> 备注：本模块仅提供最小原语与运算闭包，不负责“上下文拼写策略”（例如按调号选择升降号书写）。若需要 Key-aware 拼写决策，应在上层策略模块实现，而不是污染 Domain Core。

---

## 2. 和声素材 (Harmonic Materials)

### Intervals (音程)
描述两个音之间的度数与半音距离。
* **P1/P4/P5/P8 (纯音程)**: 听感协和、空洞、稳定。用于架构支撑。
* **M3/m3/M6/m6 (大小音程)**: 听感丰满，决定大调或小调色彩的关键。
* **d5/A4 (三全音)**: 包含于 `d5` (Degrees.V) 或 `A4` (Degrees.IV)。极度不协和，具有强烈的解决倾向（如 G7 和弦中的 B-F 音程）。

### Qualities (和弦性质)
描述和弦的色彩与张力结构。
* **maj/min**: 基础的大三/小三和弦，音乐的基石。
* **maj7 (大七)**: 梦幻、宽广。常见于现代流行与爵士的主和弦。
* **dom7 (_7)**: 也就是属七和弦。具有强烈的不稳定性，迫切想要解决回主和弦 (V7 -> I)。
* **dim7 (减七)**: 极度紧张、戏剧性，常用于转调或惊悚氛围。

### Functions (功能)
描述和弦在进行中的“角色”。
* **Tonic (主)**: 稳定，家，归宿。
* **Dominant (属)**: 紧张，导向主功能。
* **Subdominant (下属)**: 过渡，色彩变化，通常引向属功能。
* **Characteristic (特征)**: 包含调式特征音的和弦。

---

## 3. 调式与风格 (Modes & Style)

### Modes (教会调式)
描述不同的音阶排列模式，带来独特的情绪氛围。
* **Ionian**: 即自然大调，明亮、正统。
* **Dorian**: 小调色彩但带有大六度（特征音），听感“忧郁但明亮”，常见于凯尔特音乐或放克。
* **Aeolian**: 即自然小调，悲伤、深沉。

### Textures (织体)
描述音乐在纵向和横向上的呈现形态。
* **Columnar (柱式)**: 所有声部同时发声（如赞美诗），强调和声块状感。
* **Triangular (三角)**: 贝斯支撑，上方声部律动，类似华尔兹伴奏。
* **Decomposition (分解)**: 和弦音分散奏出（如阿尔贝蒂低音），强调流动感。

---

## 4. 声部进行法则 (Voice Leading)

### LeadingType (连接方式)
描述声部从一个音运动到下一个音的方式。
* **Step (级进)**: 平稳移动（如 C -> D）。最理想的声部连接，听感流畅。
* **Jump (跳进)**: 跨越三度或以上的移动（如 C -> G）。增加旋律活力，但需谨慎使用。
* **Suspend (延留)**: 前一个和弦的音在当前和弦保持，造成暂时的不协和，随后解决。

### TurningPoints (导向点/倾向音)
描述音阶中具有强烈运动倾向的关键音。
* **Ascending_VII (导音)**: 音阶第 7 级。在 V7 和弦中，强烈倾向于上行解决到主音 (Ti -> Do)。
* **Descending_VI**: 在小调或特定进行中，第 6 级音往往倾向于下行解决到第 5 级 (Le -> Sol)。

### Voices (声部分配)
遵循传统的四部和声 (SATB) 架构：
* **Bass**: 和声基础，决定转位。
* **Soprano**: 旋律轮廓。
* **Alto/Tenor**: 内声部，负责填充和声色彩与连接。
